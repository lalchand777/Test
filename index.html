<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Universal AI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="bg-gray-100 text-gray-900 min-h-screen">

<!-- Loading -->
<div id="loading" class="h-screen flex items-center justify-center text-gray-500">
  Loading App...
</div>

<!-- App -->
<div id="app" class="hidden flex min-h-screen">

  <!-- Sidebar -->
  <aside class="w-72 bg-white border-r flex flex-col">
    <div class="p-4 border-b flex justify-between items-center">
      <h2 class="font-semibold">Chat History</h2>
      <button id="newChatBtn" class="text-blue-600 text-sm">New</button>
    </div>
    <div id="chatList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    <button id="settingsBtn" class="m-3 text-sm text-gray-600">âš™ Settings</button>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col bg-gray-50">

    <!-- Chat -->
    <div id="chatWindow" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

    <!-- Input -->
    <div class="sticky bottom-0 bg-white border-t p-4">
      <div class="flex items-center bg-gray-100 rounded-full px-4">
        <input id="userInput" type="text" placeholder="Ask anything..."
          class="flex-1 bg-transparent py-3 outline-none">
        <button id="sendBtn" class="text-blue-600 font-semibold">Send</button>
      </div>
    </div>

  </main>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center">
  <div class="bg-white w-96 rounded-lg p-6 space-y-4">
    <h3 class="text-lg font-semibold">Settings</h3>

    <div>
      <label class="text-sm">OpenRouter API Key</label>
      <input id="apiKeyInput" type="password" class="w-full border rounded px-3 py-2 mt-1">
    </div>

    <div>
      <label class="text-sm">Model Name</label>
      <input id="modelInput" type="text" class="w-full border rounded px-3 py-2 mt-1">
    </div>

    <div class="flex justify-end gap-2 pt-2">
      <button id="closeSettings">Cancel</button>
      <button id="saveSettings" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
    </div>
  </div>
</div>

<!-- SCRIPT (END OF BODY) -->
<script>
/* ================= STATE ================= */
let chats = JSON.parse(localStorage.getItem("chats") || "[]");
let currentChatId = null;

/* ================= ELEMENTS ================= */
const loading = document.getElementById("loading");
const app = document.getElementById("app");
const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const userInput = document.getElementById("userInput");
const settingsModal = document.getElementById("settingsModal");
const apiKeyInput = document.getElementById("apiKeyInput");
const modelInput = document.getElementById("modelInput");

/* ================= INIT ================= */
function init() {
  apiKeyInput.value = localStorage.getItem("openrouter_api_key") || "";
  modelInput.value = localStorage.getItem("openrouter_model") || "deepseek/deepseek-r1:free";

  if (!chats.length) createNewChat();
  renderChatList();
  openChat(chats[0].id);

  loading.classList.add("hidden");
  app.classList.remove("hidden");
}
window.onload = init;

/* ================= CHAT ================= */
function createNewChat() {
  const id = Date.now();
  chats.unshift({
    id,
    title: "New Chat",
    messages: [{
      role: "assistant",
      content: "Hello ðŸ‘‹ Iâ€™m your AI assistant. How can I help you today?"
    }]
  });
  saveChats();
}

function openChat(id) {
  currentChatId = id;
  renderMessages();
}

function renderChatList() {
  chatList.innerHTML = "";
  chats.forEach(c => {
    const d = document.createElement("div");
    d.className = "p-2 rounded cursor-pointer hover:bg-gray-100 text-sm";
    d.textContent = c.title;
    d.onclick = () => openChat(c.id);
    chatList.appendChild(d);
  });
}

function renderMessages() {
  chatWindow.innerHTML = "";
  const chat = chats.find(c => c.id === currentChatId);
  chat.messages.forEach(m => addBubble(m.role, m.content));
  scrollBottom();
}

/* ================= UI HELPERS ================= */
function addBubble(role, content) {
  const div = document.createElement("div");
  div.className = role === "user"
    ? "ml-auto bg-blue-600 text-white p-3 rounded-xl max-w-xl"
    : "mr-auto bg-white p-3 rounded-xl max-w-xl border";

  div.innerHTML = role === "assistant" ? marked.parse(content) : content;
  chatWindow.appendChild(div);
}

function scrollBottom() {
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* ================= TYPING EFFECT ================= */
function typeText(element, text) {
  let i = 0;
  element.innerHTML = "";
  const interval = setInterval(() => {
    element.innerHTML += text.charAt(i);
    i++;
    scrollBottom();
    if (i >= text.length) clearInterval(interval);
  }, 15);
}

/* ================= SEND MESSAGE ================= */
async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;
  userInput.value = "";

  const chat = chats.find(c => c.id === currentChatId);
  chat.messages.push({ role: "user", content: text });
  chat.title = chat.title === "New Chat" ? text.slice(0, 30) : chat.title;
  saveChats();
  renderChatList();
  addBubble("user", text);

  const aiDiv = document.createElement("div");
  aiDiv.className = "mr-auto bg-white p-3 rounded-xl max-w-xl border text-gray-500";
  aiDiv.textContent = "Thinking...";
  chatWindow.appendChild(aiDiv);
  scrollBottom();

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + apiKeyInput.value,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: modelInput.value,
        messages: chat.messages
      })
    });

    const data = await res.json();
    const reply = data.choices[0].message.content;

    aiDiv.classList.remove("text-gray-500");
    aiDiv.innerHTML = "";
    typeText(aiDiv, reply);

    chat.messages.push({ role: "assistant", content: reply });
    saveChats();

  } catch {
    aiDiv.textContent = "Error fetching response.";
  }
}

/* ================= STORAGE ================= */
function saveChats() {
  localStorage.setItem("chats", JSON.stringify(chats));
}

/* ================= EVENTS ================= */
document.getElementById("sendBtn").onclick = sendMessage;
userInput.addEventListener("keydown", e => e.key === "Enter" && sendMessage());

document.getElementById("newChatBtn").onclick = () => {
  createNewChat();
  renderChatList();
  openChat(chats[0].id);
};

document.getElementById("settingsBtn").onclick = () => settingsModal.classList.remove("hidden");
document.getElementById("closeSettings").onclick = () => settingsModal.classList.add("hidden");
document.getElementById("saveSettings").onclick = () => {
  localStorage.setItem("openrouter_api_key", apiKeyInput.value);
  localStorage.setItem("openrouter_model", modelInput.value);
  settingsModal.classList.add("hidden");
};
</script>

</body>
</html>
