<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Universal AI Chat</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html, body {
      height: 100%;
    }
    body {
      overscroll-behavior: none;
    }
    .typing-cursor::after {
      content: "‚ñç";
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
  </style>
</head>

<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<!-- Fallback Loader -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
  <div class="text-lg font-semibold">Loading App...</div>
</div>

<!-- APP -->
<div id="app" class="min-h-screen flex overflow-hidden">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex-shrink-0 transform transition-transform duration-200 md:translate-x-0 -translate-x-full md:relative fixed inset-y-0 z-40">
    <div class="p-4 flex justify-between items-center">
      <span class="font-semibold">Chats</span>
      <button id="newChatBtn" class="text-sm text-blue-600">+ New</button>
    </div>
    <div id="chatList" class="overflow-y-auto h-full px-2 pb-20"></div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col min-h-screen">

    <!-- Top Bar -->
    <header class="flex items-center justify-between p-3 border-b dark:border-gray-700">
      <button id="menuBtn" class="md:hidden">‚ò∞</button>
      <div class="flex gap-3">
        <button id="darkToggle">üåô</button>
        <button id="settingsBtn">‚öôÔ∏è</button>
      </div>
    </header>

    <!-- Messages -->
    <section id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></section>

    <!-- Input -->
    <footer class="sticky bottom-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3">
      <div class="flex gap-2">
        <textarea id="input" rows="1" placeholder="Message..." class="flex-1 resize-none p-2 rounded border dark:bg-gray-700"></textarea>
        <button id="sendBtn" class="px-4 bg-blue-600 text-white rounded">Send</button>
      </div>
    </footer>
  </main>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded w-80 space-y-4">
    <h2 class="font-semibold text-lg">Settings</h2>
    <input id="apiKey" type="password" placeholder="OpenRouter API Key" class="w-full p-2 border rounded">
    <input id="model" placeholder="Model" class="w-full p-2 border rounded">
    <textarea id="systemPrompt" rows="3" placeholder="System Prompt" class="w-full p-2 border rounded"></textarea>
    <div class="flex justify-end gap-2">
      <button onclick="closeSettings()">Cancel</button>
      <button onclick="saveSettings()" class="text-blue-600">Save</button>
    </div>
  </div>
</div>

<script>
/* =========================
   STATE
========================= */
const state = {
  chats: JSON.parse(localStorage.getItem("chats") || "[]"),
  currentChatId: null,
  apiKey: localStorage.getItem("apiKey") || "",
  model: localStorage.getItem("model") || "deepseek/deepseek-r1:free",
  systemPrompt: localStorage.getItem("systemPrompt") || "",
  dark: localStorage.getItem("dark") === "true"
};

/* =========================
   INIT
========================= */
document.documentElement.classList.toggle("dark", state.dark);
document.getElementById("loading").style.display = "none";

if (!state.chats.length) newChat();
renderChats();

/* =========================
   CHAT MANAGEMENT
========================= */
function newChat() {
  const chat = { id: Date.now(), title: "New Chat", messages: [] };
  state.chats.unshift(chat);
  state.currentChatId = chat.id;
  save();
  renderChats();
  renderMessages();
}

function renderChats() {
  const list = document.getElementById("chatList");
  list.innerHTML = "";
  state.chats.forEach(chat => {
    const div = document.createElement("div");
    div.className = "p-2 rounded cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700";
    div.textContent = chat.title;
    div.onclick = () => {
      state.currentChatId = chat.id;
      renderMessages();
    };
    list.appendChild(div);
  });
}

function renderMessages() {
  const box = document.getElementById("messages");
  box.innerHTML = "";
  const chat = getChat();
  if (!chat) return;
  chat.messages.forEach(m => addMessage(m.role, m.content));
}

/* =========================
   MESSAGES
========================= */
function addMessage(role, content, streaming=false) {
  const div = document.createElement("div");
  div.className = role === "user" ? "text-right" : "text-left";
  const bubble = document.createElement("div");
  bubble.className = "inline-block p-3 rounded max-w-[85%] prose dark:prose-invert bg-gray-200 dark:bg-gray-700";
  bubble.innerHTML = marked.parse(content);
  if (streaming) bubble.classList.add("typing-cursor");
  div.appendChild(bubble);
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return bubble;
}

/* =========================
   SEND + STREAM
========================= */
async function send() {
  const text = input.value.trim();
  if (!text) return;
  input.value = "";
  const chat = getChat();
  chat.messages.push({ role: "user", content: text });
  addMessage("user", text);
  save();

  const aiBubble = addMessage("assistant", "", true);

  const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + state.apiKey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: state.model,
      stream: true,
      messages: [
        ...(state.systemPrompt ? [{ role: "system", content: state.systemPrompt }] : []),
        ...chat.messages
      ]
    })
  });

  const reader = res.body.getReader();
  let full = "";
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    const chunk = new TextDecoder().decode(value);
    chunk.split("\n").forEach(line => {
      if (line.startsWith("data: ")) {
        const data = line.replace("data: ", "");
        if (data === "[DONE]") return;
        try {
          const json = JSON.parse(data);
          const token = json.choices[0].delta?.content || "";
          full += token;
          aiBubble.innerHTML = marked.parse(full);
        } catch {}
      }
    });
  }
  aiBubble.classList.remove("typing-cursor");
  chat.messages.push({ role: "assistant", content: full });
  save();
}

/* =========================
   SETTINGS
========================= */
function saveSettings() {
  state.apiKey = apiKey.value;
  state.model = model.value;
  state.systemPrompt = systemPrompt.value;
  save();
  closeSettings();
}

function closeSettings() {
  settingsModal.classList.add("hidden");
}

/* =========================
   HELPERS
========================= */
function getChat() {
  return state.chats.find(c => c.id === state.currentChatId);
}

function save() {
  localStorage.setItem("chats", JSON.stringify(state.chats));
  localStorage.setItem("apiKey", state.apiKey);
  localStorage.setItem("model", state.model);
  localStorage.setItem("systemPrompt", state.systemPrompt);
  localStorage.setItem("dark", state.dark);
}

/* =========================
   EVENTS
========================= */
sendBtn.onclick = send;
settingsBtn.onclick = () => settingsModal.classList.remove("hidden");
darkToggle.onclick = () => {
  state.dark = !state.dark;
  document.documentElement.classList.toggle("dark", state.dark);
  save();
};
menuBtn.onclick = () => sidebar.classList.toggle("-translate-x-full");
newChatBtn.onclick = newChat;
</script>

</body>
</html>
